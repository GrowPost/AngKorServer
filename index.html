<!-- Add Chart.js CDN in <head> -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- HEADER -->
<header class="header">
  <div class="header-top">
    <img src="assets/AngkorPS.png" alt="AngkorPS Logo" class="header-logo">
    <h1 class="title">AngkorPS</h1>
  </div>
  <p class="subtitle">Experience playing on Growtopia private server with exciting gameplay and stable system.</p>
</header>

<!-- LIVE ONLINE PLAYERS GRAPH -->
<div class="card">
  <h3><i class="fas fa-chart-line"></i> Online Players Live</h3>
  <canvas id="onlineChart" height="100"></canvas>
</div>

<style>
/* HEADER IMPROVEMENTS */
.header { text-align:center; margin-bottom:2rem; padding:1rem 0; background:#11151c; border-radius:12px; border:1px solid #1f242c; }
.header-top { display:flex; align-items:center; justify-content:center; gap:1rem; margin-bottom:.5rem; }
.header-logo { width:50px; height:50px; border-radius:10px; object-fit:cover; }
.header .title { font-size:2.6rem; font-weight:700; color:#10b981; }
.header .subtitle { color:#b5b5b5; font-size:1rem; }

/* CHART */
#onlineChart { width:100%; background:#161b23; border-radius:12px; padding:10px; }
</style>

<script>
// Live online players chart
const ctx = document.getElementById('onlineChart').getContext('2d');
const onlineChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: [], // time labels
        datasets: [{
            label: 'Players Online',
            data: [],
            borderColor: '#10b981',
            backgroundColor: 'rgba(16,185,129,0.2)',
            fill: true,
            tension: 0.3,
            pointRadius: 3,
        }]
    },
    options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
            x: { title: { display: true, text: 'Time' }, ticks: { color: '#e5e5e5' }, grid: { color: '#1f242c' } },
            y: { title: { display: true, text: 'Players' }, ticks: { color: '#e5e5e5' }, grid: { color: '#1f242c' }, beginAtZero: true }
        }
    }
});

// Update chart every 5 seconds
function updateChart(count) {
    const time = new Date().toLocaleTimeString();
    if (onlineChart.data.labels.length > 20) {
        onlineChart.data.labels.shift();
        onlineChart.data.datasets[0].data.shift();
    }
    onlineChart.data.labels.push(time);
    onlineChart.data.datasets[0].data.push(count);
    onlineChart.update();
}

// Modify updateServer() to update chart
async function updateServer(){
  try{
    const res = await fetch("https://angkorps.site/api/ping");
    const data = await res.json();

    const statusEl = document.getElementById("serverStatus");
    statusEl.textContent = data.serverStatus === "online" ? "ONLINE" : "OFFLINE";
    statusEl.style.color = data.serverStatus === "online" ? "#10b981" : "red";

    const playersCount = data.onlinePlayersCount ?? 0;
    document.getElementById("playersCount").textContent = playersCount;

    updateChart(playersCount); // <-- update chart

    const lb = document.getElementById("leaderboardList");
    lb.innerHTML = "";

    if(data.leaderboard && data.leaderboard.length > 0){
      data.leaderboard.forEach((entry) => {
        const parts = entry.split(" ");  
        const rank = parts[0];
        const name = parts[1];
        const amount = parts[2];
        const wlText = parts[3];

        const li = document.createElement("li");
        li.className = "lb-item";
        li.innerHTML = `
          <span>${rank} ${name}</span>
          <span class="lb-wl">
            ${amount} ${wlText}
            <img src="assets/world_lock.png" alt="WL">
          </span>
        `;
        lb.appendChild(li);
      });
    } else {
      lb.innerHTML = "<li>No players found</li>";
    }

  } catch {
    document.getElementById("serverStatus").textContent="OFFLINE";
    document.getElementById("serverStatus").style.color="red";
    document.getElementById("playersCount").textContent=0;
    document.getElementById("leaderboardList").innerHTML="<li>No data</li>";
    updateChart(0);
  }
}

updateServer();
setInterval(updateServer,5000);
</script>
